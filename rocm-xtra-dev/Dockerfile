ARG UBUNTU_VERSION
ARG ROCM_ARCH
ARG ROCM_MAJOR_VERSION
ARG ROCM_MINOR_VERSION
ARG ROCM_PATCH_VERSION
ARG ROCM_BUILD_NUMBER
ARG ROCM_LIBPATCH_VERSION
ARG ROCM_VERSION
ARG ROCM_VERSION_DOCKER
ARG MAGMA_VERSION
ARG ROCBLAS_BASE_URL
ARG ROCBLAS_FILE
ARG ROCBLAS_DEV_FILE
ARG PYTHON_VERSION
ARG PYTORCH_VERSION
ARG PYTORCH_VISION_VERSION
ARG OPENCV_VERSION
ARG GFX803_DIST_BASE_URL
ARG GFX803_DIST_TORCH_WHEEL
ARG GFX803_DIST_TORCHVISION_WHEEL
ARG NUM_CPU_CORES

FROM ulyssesrr/rocm-xtra-rocblas-builder:ubuntu${UBUNTU_VERSION}_rocm${ROCM_VERSION} as rocblas-package-builder

FROM rocm/dev-ubuntu-${UBUNTU_VERSION}:${ROCM_VERSION_DOCKER}-complete

ARG UBUNTU_VERSION
ARG ROCM_ARCH
ARG ROCM_MAJOR_VERSION
ARG ROCM_MINOR_VERSION
ARG ROCM_PATCH_VERSION
ARG ROCM_BUILD_NUMBER
ARG ROCM_LIBPATCH_VERSION
ARG ROCM_VERSION
ARG MAGMA_VERSION
ARG ROCBLAS_BASE_URL
ARG ROCBLAS_FILE
ARG ROCBLAS_DEV_FILE
ARG PYTHON_VERSION
ARG PYTORCH_VERSION
ARG PYTORCH_VISION_VERSION
ARG OPENCV_VERSION
ARG GFX803_DIST_BASE_URL
ARG GFX803_DIST_TORCH_WHEEL
ARG GFX803_DIST_TORCHVISION_WHEEL
ARG NUM_CPU_CORES

LABEL org.opencontainers.image.authors="Ulysses R. Ribeiro <ulyssesrr@gmail.com>"

# replace rocblas with fixed version
WORKDIR /tmp/rocblas
COPY --from=rocblas-package-builder /rocblas-deb/*.deb .

RUN dpkg -i /tmp/rocblas/*.deb \
    && rm -f /tmp/rocblas/*.deb

# apt install utilities
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    git \
    python-is-python3 \
    nano \
    wget \
    && rm -rf /var/lib/apt/lists/*
